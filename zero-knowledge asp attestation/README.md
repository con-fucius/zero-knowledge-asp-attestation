# ZK ASP Attestation PoC

This PoC project demonstrates a framework for Association Set Providers (ASPs) in a Privacy Pools-like ecosystem to generate Zero-Knowledge Proofs attesting to the integrity of their exclusion set commitments. Users can then potentially aggregate these attestations.

**Disclaimer:** This is a demonstration project intended for educational purposes. The ZK circuits are simplified, it lacks robust error handling, and it has not undergone security audits. **DO NOT USE IN PRODUCTION.**

## Architecture Overview

1.  **ZK Circuit (`circuits/attestation`):**
    *   A simplified Circom circuit (`attestation.circom`).
    *   Proves knowledge of a Merkle path for a leaf within a committed root.
    *   Includes a basic check that this leaf is different from a known "bad" leaf (this is a *proxy* for real non-membership proofs).

2.  **ASP Service (`asp-service`):**
    *   A Python FastAPI backend simulating an ASP.
    *   Loads a mock blocklist (`mock_ofac.json`).
    *   Builds a Merkle tree from the list (padded to a fixed size).
    *   Uses a helper Node.js script (`scripts/generate_proof.js`) to call SnarkJS and generate ZK proofs based on the circuit and current Merkle tree state.
    *   Serves the latest Merkle root commitment and its corresponding ZK proof via a simple API (`/latest-attestation`).

3.  **Smart Contracts (`contracts`):**
    *   `Verifier.sol`: Solidity contract automatically generated by SnarkJS during the ZK setup. It verifies the Groth16 ZK proofs on-chain.
    *   `ASPRegistry.sol`: Allows trusted ASP addresses (managed by an owner) to register and submit their Merkle root commitments along with the ZK proofs. The contract uses the `Verifier` to validate the proof before storing the attestation.

4.  **Scripts (`scripts`):**
    *   `setup_zk.js`: Node.js script to perform the ZK trusted setup steps (compiling circuit, phase 2 ceremony simulation, generating keys and verifier contract).
    *   `generate_proof.js`: Node.js helper script called by the Python ASP service to interact with SnarkJS for proof generation.
    *   `deploy.js`: Hardhat script to deploy the `Verifier` and `ASPRegistry` contracts to a specified network (defaults to local Hardhat network).
    *   `submit_attestation.js`: Hardhat script that simulates an ASP fetching the latest attestation data from the ASP service API and submitting it to the `ASPRegistry` smart contract.

## Setup Instructions

**Prerequisites:**

*   Node.js (v18+ recommended) & npm
*   Python (v3.9+ recommended) & pip
*   Circom compiler installed globally (`npm install -g circom`)

**Steps:**

1.  **Clone Repository:**
    ```bash
    git clone <your-repo-url> zk-asp-attestation
    cd zk-asp-attestation
    ```

2.  **Install Node Dependencies:**
    ```bash
    npm install
    ```

3.  **Install Python Dependencies:**
    ```bash
    # Recommended: Create and activate a virtual environment first
    # python -m venv venv
    # source venv/bin/activate  # On Linux/macOS
    # venv\Scripts\activate    # On Windows
    pip install -r asp-service/requirements.txt
    ```

4.  **Download Powers of Tau File:**
    *   A "Powers of Tau" file is required for the ZK trusted setup. For the demo circuit size (`Attestation(4)`), `powersOfTau28_hez_final_14.ptau` is sufficient.
    *   Download this file from a trusted source (e.g., search "snarkjs powers of tau download" or check the Perpetual Powers of Tau ceremony archives). **This file is approximately 100MB.**
    *   Place the downloaded `.ptau` file directly inside the `circuits/` directory. Ensure the filename is exactly `powersOfTau28_hez_final_14.ptau`.

5.  **Compile Circuit & Run ZK Setup:**
    *   This step compiles the Circom circuit, performs the (insecure demo) trusted setup using the `.ptau` file, generates the proving key (`.zkey`), verification key (`.json`), and the `Verifier.sol` contract.
    ```bash
    npm run setup:zk
    ```
    *   Verify that `contracts/Verifier.sol` has been created.

6.  **Compile Smart Contracts:**
    *   This compiles `ASPRegistry.sol` and the generated `Verifier.sol`.
    ```bash
    npm run compile:contracts
    ```

## Running the Local Demo

You will need 3 separate terminal windows open, all navigated to the `zk-asp-attestation` project root directory.

1.  **Terminal 1: Start Local Blockchain:**
    ```bash
    npx hardhat node
    ```
    *   Keep this running. Note the RPC URL (e.g., `http://127.0.0.1:8545/`).

2.  **Terminal 2: Deploy Contracts:**
    ```bash
    npm run deploy:local
    ```
    *   Wait for deployment to finish.
    *   **ACTION:** Copy the `ASPRegistry Address` printed in the output (it will look like `0x...`).

3.  **Terminal 2: Configure Submission Script:**
    *   **ACTION:** Open the file `scripts/submit_attestation.js` in your text editor.
    *   Find the line: `const REGISTRY_ADDRESS = "YOUR_ASP_REGISTRY_CONTRACT_ADDRESS";`
    *   Replace the placeholder string with the actual `ASPRegistry Address` you copied.
    *   Save the file.

4.  **Terminal 3: Start ASP Service:**
    ```bash
    npm run start:asp
    ```
    *   Keep this running. Watch for output indicating the service started, loaded the mock list, and generated the initial proof.

5.  **Terminal 2: Submit Attestation:**
    *   Wait a few seconds after the ASP service confirms it generated the initial proof.
    *   Run the submission script:
    ```bash
    npm run submit
    ```

**Expected Outcome:**

The `npm run submit` script should:
*   Fetch data from the running ASP service (Terminal 3).
*   Connect to the `ASPRegistry` contract on the local Hardhat node (Terminal 1).
*   Send a transaction to submit the attestation.
*   Print "Attestation submitted successfully!" and show the latest attestation details retrieved from the contract.

## Limitations & Future Work

*   **Simplified ZK Logic:** The proof only validates one path and difference from one bad leaf. Real non-membership proofs are more complex.
*   **Insecure Setup:** The ZK trusted setup is insecure for production.
*   **Mock Data:** Uses a static mock blocklist.
*   **No Aggregation:** This demo focuses on single ASP attestation, not aggregation.
*   **Basic Error Handling:** Needs more robust error checks.
*   **Security:** Not audited. Consider potential vulnerabilities in contracts, ZK circuits, and the API.